---
title: "DATRAS"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(sf)
library(duckdb)
library(duckdbfs)
library(dplyr)
library(tidyr)
library(ggplot2)
library(Hmisc) # call so posit "knows"
drp_length <- function(by.length, y = b, S = input$survey, L = input$latin) {
  by.length |>
    filter(survey == S, latin == L) |>
    ggplot(aes(length, {{ y }})) +
    theme_bw(base_size = 10) +
    geom_col(fill = "grey25", colour = "grey25") +
    facet_wrap(~ year) +
    labs(x = "Lengd [cm]", y = "Total survey catch [kg/cm]")
}
drp_boot <- function(hh, by.station, y = b, S = input$survey, L = input$latin) {
  hh |>
    select(.id, survey, year) |>
    filter(survey %in% S) |>
    left_join(by.station |> filter(latin == L),
              by = join_by(.id)) |>
    collect() |>
    mutate(n = replace_na(n, 0),
           b = replace_na(b, 0)) |>
    ggplot(aes(year, {{ y }})) +
    theme_bw(base_size = 12) +
    stat_summary(fun.data = "mean_cl_boot") +
    expand_limits(y = 0) +
    labs(x = NULL, y = "CPUE [kg/tow]")
}

drp_bubble <- function(hh, by.station, y = b, S = input$survey, L = input$latin, ne = ne) {

  hh2 <-
    hh |>
    filter(survey %in% S)
  
  bb <-
    hh2 |>
    summarise(xmin = min(lon, na.rm = TRUE),
              ymin = min(lat, na.rm = TRUE),
              xmax = max(lon, na.rm = TRUE),
              ymax = max(lat, na.rm = TRUE)) |> 
    collect()
  
  maxyear <- hh2 |> collect() |> pull(year) |> max(na.rm = TRUE)
  
  hh2 <-
    hh2 |>
    filter(year == maxyear) |>
    left_join(by.station |> filter(latin == L),
              by = join_by(.id)) |>
    collect() |>
    mutate(zero = ifelse(is.na(n), "yes", "no"),
           n = replace_na(n, 0),
           b = replace_na(b, 0))
  
  
  ggplot() +
    theme_void() +
    geom_sf(data = ne) +
    geom_point(data = hh2,
               aes(lon, lat, size = {{ y }}, colour = zero),
               alpha = 0.75) +
    scale_size_area(max_size = 10) +
    labs(x = NULL, y = NULL, size = "Kg/tow") +
    coord_sf(xlim = c(bb$xmin, bb$xmax), ylim = c(bb$ymin, bb$ymax)) +
    facet_wrap(~ year)
}

hh <- open_dataset("https://heima.hafro.is/~einarhj/datras/haul.parquet")
by.length <- open_dataset("https://heima.hafro.is/~einarhj/datras/by_length.parquet")
by.station <- open_dataset("https://heima.hafro.is/~einarhj/datras/by_station.parquet")

ne <- read_sf("data/ne.gpkg")

# Create the survey list user will choose from
menu <- 
  by.length |>
  filter(survey != "-") |> 
  select(survey, year, latin) |> 
  distinct() |> 
  group_by(survey, latin) |> 
  summarise(n = n_distinct(year),
            .groups = "drop") |> 
  filter(n > 5) |> 
  select(survey, latin) |> 
  distinct() |> 
  collect() |> 
  arrange(survey, latin)

by.length <- 
  by.length |>
  filter(survey != "-")
```

Sidebar {.sidebar data-width=175}
=====================================

```{r}
# Territory selection
selectInput(
  "survey", 
  "Survey", 
  choices = menu$survey,
  selected = 1
)

# Latin selection (updates reactively)
uiOutput("latin_ui")
```

Headlines
=====================================  

Column 
-------------------------------------

### By length

```{r, eval = TRUE}
renderPlot({
  drp_length(by.length, S = input$survey, L = input$latin)
})
```

Column 
-------------------------------------

### CPUE - bootstrap

```{r, eval = TRUE}
renderPlot({
  drp_boot(hh, by.station, S = input$survey, L = input$latin)
})
```

### Catch by station - last survey year

```{r, eval = TRUE}
renderPlot({
  hh |>
    drp_bubble(by.station, S = input$survey, L = input$latin, ne = ne)
})
```

Distributions
=====================================

Column {.tabset}
-------------------------------------

### Method




```{r, context="server"}
# SERVER LOGIC

# Filtered 
survey_r <- reactive({
  req(menu$survey)
  filter(menu, survey == input$survey)
})

# Dynamic UI for latin
output$latin_ui <- renderUI({
  selectInput(
    "latin", 
    "Latin",
    choices = sort(unique(survey_r()$latin)),
    selected = 1
  )
})
```
